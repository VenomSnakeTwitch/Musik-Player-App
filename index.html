<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#9146ff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="VenomPlayer">
<meta name="description" content="VenomSnake_Twitch's Musikplayer - Eigene Musik mit Suno.com erstellt">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/VenomSnakeTwitch/VenomSnake_Twitch-Webseite/main/DogVenomsnakeLogo.png">
<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/VenomSnakeTwitch/VenomSnake_Twitch-Webseite/main/favicon.ico">
<title>VenomSnake Musikplayer ‚Äì PWA</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

:root {
    --primary: #9146ff;
    --accent: #00ffff;
    --bg-dark: #000033;
    --bg-overlay: rgba(0,0,50,0.85);
    --text-light: #f0f0ff;
    --text-muted: #c0c0ff;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: 'Orbitron', sans-serif;
    background: url("https://raw.githubusercontent.com/VenomSnakeTwitch/VenomSnake_Twitch-Webseite/main/musicbackground.png") no-repeat center center fixed;
    background-size: cover;
    color: var(--text-light);
    min-height: 100dvh;
    overflow-x: hidden;
}

/* PWA Install Banner */
#installBanner {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, var(--primary), var(--bg-dark));
    padding: 16px 20px;
    z-index: 3000;
    flex-direction: column;
    gap: 12px;
    border-top: 2px solid var(--accent);
    animation: slideUp 0.5s ease;
}
@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}
#installBanner p { font-size: 14px; color: #fff; }
#installBanner .btn-row { display: flex; gap: 10px; }
#installBtn {
    background: var(--accent);
    color: var(--bg-dark);
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    flex: 1;
}
#dismissBtn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.5);
    color: #fff;
    padding: 12px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
}

/* Header */
header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px;
    z-index: 1000;
}
.logo-container {
    display: flex;
    align-items: center;
    gap: 8px;
}
.logo-container img { 
    height: 36px; 
    width: 36px;
    object-fit: contain;
    border-radius: 50%;
}
.logo-container span {
    font-size: 16px;
    font-weight: bold;
    color: var(--primary);
    text-shadow: 0 0 8px var(--accent);
}
.logo-container .snake { color: var(--accent); }

.header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}
.header-btn {
    padding: 8px 12px;
    font-size: 1rem;
    background: rgba(145,70,255,0.3);
    border: 1px solid var(--primary);
    border-radius: 6px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
}
.header-btn:hover { background: rgba(145,70,255,0.5); }

/* Main Container */
#app {
    background: var(--bg-overlay);
    min-height: 100dvh;
    padding: 80px 16px 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

h1 {
    font-size: clamp(20px, 5vw, 32px);
    text-align: center;
    color: #fff;
    text-shadow: 0 0 12px var(--accent), 0 0 24px var(--bg-dark);
    margin-bottom: 8px;
}

#infoText {
    font-size: 12px;
    color: var(--text-muted);
    text-align: center;
    max-width: 90%;
    margin-bottom: 16px;
}

#currentSong {
    font-size: clamp(14px, 3.5vw, 20px);
    color: var(--accent);
    text-align: center;
    padding: 8px 16px;
    background: rgba(0,255,255,0.1);
    border-radius: 20px;
    margin-bottom: 16px;
    max-width: 95%;
    word-wrap: break-word;
}

/* Song Select */
#songSelect {
    width: 100%;
    max-width: 400px;
    padding: 14px 16px;
    font-size: 14px;
    border: 2px solid var(--accent);
    border-radius: 12px;
    background: rgba(0,0,50,0.9);
    color: #fff;
    margin-bottom: 16px;
    cursor: pointer;
}

/* Progress Section */
.progress-section {
    width: 100%;
    max-width: 400px;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}
.time-label {
    font-size: 12px;
    color: var(--text-muted);
    min-width: 40px;
    text-align: center;
}
#progress {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--accent), var(--primary));
    cursor: pointer;
    outline: none;
}
#progress::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #fff;
    border: 3px solid var(--accent);
    cursor: pointer;
    box-shadow: 0 0 10px var(--accent);
}

/* Control Buttons */
.controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 20px;
}
.ctrl-btn {
    width: 56px;
    height: 56px;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--accent);
    border-radius: 50%;
    background: rgba(0,0,50,0.8);
    color: #fff;
    cursor: pointer;
    transition: all 0.25s;
}
.ctrl-btn:hover { 
    background: rgba(20,20,80,0.9); 
    transform: scale(1.1);
}
.ctrl-btn:active { transform: scale(0.95); }
.ctrl-btn.play-btn {
    width: 72px;
    height: 72px;
    font-size: 2rem;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border: none;
}
.ctrl-btn.active {
    color: #ffdd00;
    border-color: #ffdd00;
    box-shadow: 0 0 12px #ffdd00aa;
}
.ctrl-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

/* Secondary Controls */
.secondary-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 20px;
}
.sec-btn {
    padding: 10px 16px;
    font-size: 13px;
    border: 2px solid var(--accent);
    border-radius: 25px;
    background: rgba(0,0,50,0.8);
    color: #fff;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 6px;
}
.sec-btn:hover { 
    border-color: var(--primary); 
    background: rgba(20,20,80,0.9);
}
.sec-btn.active {
    background: var(--primary);
    border-color: var(--primary);
}

/* Volume Control */
.volume-section {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
    padding: 12px 20px;
    background: rgba(0,0,40,0.7);
    border-radius: 30px;
    border: 1px solid rgba(0,255,255,0.3);
}
.volume-icon { font-size: 1.2rem; }
#volumeSlider {
    width: 120px;
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--accent), var(--primary));
    cursor: pointer;
}
#volumeSlider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #fff;
    border: 2px solid var(--accent);
    cursor: pointer;
}

/* Info Box */
#infoBox {
    width: 100%;
    max-width: 400px;
    background: rgba(10,10,30,0.95);
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 16px;
    max-height: 200px;
    overflow-y: auto;
}
#infoBox h3 {
    color: var(--accent);
    font-size: 14px;
    margin-bottom: 10px;
}
#infoBox p {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

/* ==================== VISUALIZER ==================== */
#visualizerOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(3,3,25,0.98);
    backdrop-filter: blur(14px);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 16px;
}
#visualizerOverlay.active { display: flex; }

.viz-header {
    position: absolute;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
}
.viz-header h2 {
    font-size: clamp(18px, 4vw, 28px);
    text-shadow: 0 0 20px var(--accent);
    color: var(--accent);
    letter-spacing: 3px;
}

.close-viz-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    font-size: 2rem;
    background: none;
    border: none;
    color: #ff3366;
    cursor: pointer;
    z-index: 10;
}

#visualizerCanvas {
    border-radius: 16px;
    box-shadow: 0 0 40px rgba(0,255,255,0.5);
    background: rgba(0,0,0,0.3);
    max-width: 95vw;
    max-height: 50vh;
}

.viz-mode-buttons {
    margin-top: 16px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
}
.mode-btn {
    padding: 10px 20px;
    font-size: 12px;
    background: rgba(0,0,60,0.6);
    border: 2px solid var(--accent);
    color: #fff;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
}
.mode-btn.active {
    background: linear-gradient(90deg, var(--primary), var(--accent));
    border-color: #fff;
}

#vizControls {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(0,0,40,0.9);
    padding: 12px 20px;
    border-radius: 40px;
    border: 2px solid rgba(0,255,255,0.4);
}
.viz-btn {
    width: 44px;
    height: 44px;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,60,0.8);
    border: 2px solid var(--accent);
    color: #fff;
    border-radius: 50%;
    cursor: pointer;
}
#vizPlayPauseBtn {
    width: 56px;
    height: 56px;
    font-size: 1.8rem;
}

#vizVersion {
    position: absolute;
    bottom: 12px;
    right: 16px;
    font-size: 11px;
    color: var(--accent);
    opacity: 0.6;
}

/* Light Theme */
[data-theme="light"] { --bg-overlay: rgba(245,245,255,0.92); }
[data-theme="light"] body { color: #1a1a40; }
[data-theme="light"] header { background: rgba(255,255,255,0.8); }
[data-theme="light"] h1, [data-theme="light"] #currentSong { color: #1a1a40; }
[data-theme="light"] #infoText { color: #3a3a70; }
[data-theme="light"] .ctrl-btn, [data-theme="light"] .sec-btn, [data-theme="light"] #songSelect {
    background: rgba(230,230,255,0.9);
    border-color: #4169e1;
    color: #1a1a40;
}
[data-theme="light"] #infoBox { 
    background: rgba(240,240,255,0.95); 
    border-color: #4169e1;
}
[data-theme="light"] #infoBox h3, [data-theme="light"] #infoBox p { color: #1a1a40; }

/* Responsive */
@media (max-width: 380px) {
    .ctrl-btn { width: 48px; height: 48px; font-size: 1.2rem; }
    .ctrl-btn.play-btn { width: 60px; height: 60px; font-size: 1.6rem; }
    .sec-btn { padding: 8px 12px; font-size: 11px; }
}
</style>
</head>
<body>

<header>
    <div class="logo-container">
        <img src="https://raw.githubusercontent.com/VenomSnakeTwitch/VenomSnake_Twitch-Webseite/main/DogVenomsnakeLogo.png" alt="VenomSnake Logo">
        <span>VENOM<span class="snake">SNŒõKE</span></span>
    </div>
    <div class="header-actions">
        <button id="visualizerBtn" class="header-btn" data-testid="visualizer-btn">üéµ</button>
        <button id="themeBtn" class="header-btn" data-testid="theme-btn">üåô</button>
    </div>
</header>

<div id="app">
    <h1>VenomSnake Musikplayer</h1>
    <div id="infoText">Eigene Musik erstellt mit Suno.com ‚Äì zum Anh√∂ren und Herunterladen</div>
    
    <div id="currentSong" data-testid="current-song">‚ñ∂ Kein Song ausgew√§hlt</div>
    
    <audio id="audioPlayer" preload="metadata"></audio>
    
    <select id="songSelect" data-testid="song-select">
        <option value="0">Snake Eater VenomSnake_Twitch Mix</option>
        <option value="1">Ghost Town by VenomSnake_Twitch</option>
        <option value="2">Wreckfest</option>
        <option value="3">In The Air Tonight (VenomSnake_Twitch)</option>
        <option value="4">Paradies City</option>
        <option value="5">Parasit√§res Bewustsein</option>
        <option value="6">Still Alive (Voiced)</option>
        <option value="7">Yu-Gi-Oh! Master Duel Solo Gate Theme Synth Mix</option>
        <option value="8">Bye Bye Beautiful</option>
        <option value="9">Kettenreaktion (Cover)</option>
        <option value="10">Stra√üe der Verdammnis</option>
        <option value="11">Syphon Filter Synth Mix</option>
        <option value="12">VenomSnake Mode Intro song</option>
        <option value="13">Hell March [Retaliation Cover]</option>
        <option value="14">Dance hall Dance (Cover)</option>
        <option value="15">Resident Evil 5 Desperate Escape Main Theme Music (Remix)</option>
        <option value="16">Bleed out My Frend</option>
        <option value="17">Revange</option>
        <option value="18">Revange 2</option>
        <option value="19">Survival Of Death</option>
        <option value="20">Pile of Total Wreck</option>
        <option value="21">Dessert Storm Ahead</option>
        <option value="22">Industrial Breakdown</option>
        <option value="23">Mental Breakdown</option>
        <option value="24">Metal Gear 2 Solid Snake Chasing the Green Beret Remix</option>
        <option value="25">Metal Gear 2 Solid Snake Freqency 140.85 Remix Version 2026</option>
        <option value="26">Metal Gear 2 Solid Snake Level1 Warning Remix</option>
        <option value="27">Metal Gear 2 Solid Snake Level3 Warning Remix</option>
        <option value="28">Metal Gear 2 Solid Snake Reprieve of The Doctor Remix</option>
        <option value="29">Operation Stealth Destruction</option>
        <option value="30">Takin' On The Shagohod Remake</option>
    </select>
    
    <div class="progress-section">
        <span id="timeLabel" class="time-label">0:00</span>
        <input type="range" id="progress" min="0" max="100" value="0" data-testid="progress-slider">
        <span id="durationLabel" class="time-label">0:00</span>
    </div>
    
    <div class="controls">
        <button id="prevBtn" class="ctrl-btn" data-testid="prev-btn">‚èÆ</button>
        <button id="loopBtn" class="ctrl-btn" title="Song wiederholen" data-testid="loop-btn">üîÅ</button>
        <button id="playPauseBtn" class="ctrl-btn play-btn" data-testid="play-pause-btn">‚ñ∂</button>
        <button id="stopBtn" class="ctrl-btn" data-testid="stop-btn">‚èπ</button>
        <button id="nextBtn" class="ctrl-btn" data-testid="next-btn">‚è≠</button>
    </div>
    
    <div class="secondary-controls">
        <button id="radioToggle" class="sec-btn" data-testid="radio-toggle">üéß Radio-Modus</button>
        <a id="downloadBtn" class="sec-btn" href="" download data-testid="download-btn">‚¨á Download</a>
    </div>
    
    <div class="volume-section">
        <span class="volume-icon">üîä</span>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" data-testid="volume-slider">
    </div>
    
    <div id="infoBox">
        <h3>üéµ Neue Songs</h3>
        <p>Bleed out My Frend</p>
        <p>Revange / Revange 2</p>
        <p>Survival Of Death</p>
        <p>Metal Gear 2 Remixes</p>
        <p>Operation Stealth Destruction</p>
        <p>Takin' On The Shagohod Remake</p>
    </div>
</div>

<!-- PWA Install Banner -->
<div id="installBanner">
    <p>üì± App installieren f√ºr besseres Erlebnis!</p>
    <div class="btn-row">
        <button id="installBtn" data-testid="install-btn">Jetzt installieren</button>
        <button id="dismissBtn" data-testid="dismiss-btn">Sp√§ter</button>
    </div>
</div>

<!-- VISUALIZER OVERLAY -->
<div id="visualizerOverlay">
    <div class="viz-header"><h2>VENOM VISUALIZER</h2></div>
    <button id="closeVisualizer" class="close-viz-btn" data-testid="close-visualizer">‚úï</button>
    <canvas id="visualizerCanvas"></canvas>
    <div class="viz-mode-buttons">
        <button class="mode-btn" data-mode="0">RING</button>
        <button class="mode-btn" data-mode="1">WAVE</button>
        <button class="mode-btn active" data-mode="2">BARS</button>
        <button class="mode-btn" data-mode="3">‚ö° BLITZ</button>
    </div>
    <div id="vizControls">
        <button id="vizPrevBtn" class="viz-btn">‚èÆ</button>
        <button id="vizPlayPauseBtn" class="viz-btn">‚ñ∂</button>
        <button id="vizNextBtn" class="viz-btn">‚è≠</button>
    </div>
    <div id="vizVersion">PWA v1.0</div>
</div>

<script>
// ==================== BASE URL ====================
const BASE_URL = "https://raw.githubusercontent.com/VenomSnakeTwitch/VenomSnake_Twitch-Webseite/main/";

// ==================== SONGS ARRAY ====================
const songs = [
    "Snake Eater VenomSnake_Twitch Mix.mp3",
    "Ghost Town by VenomSnake_Twitch.mp3",
    "Wreckfest.mp3",
    "In The Air Tonight(VenomSnake_Twitch).mp3",
    "Paradies City.mp3",
    "Parasit√§res Bewustsein.mp3",
    "Still Alive (Voiced).mp3",
    "Yu-Gi-Oh! Master Duel Solo Gate Theme Synth Mix.mp3",
    "ByeByeBeautiful.mp3",
    "Kettenreaktion (Cover).mp3",
    "Strasse der Verdammnis.mp3",
    "Syphon Filter Synth Mix.mp3",
    "VenomSnake Mode Intro song.mp3",
    "Hell March [Retaliation Cover].mp3",
    "Dance hall Dance(Cover).mp3",
    "Resident Evil 5 Desperate Escape Main Theme Music(Remix).mp3",
    "Bleed out My Frend.mp3",
    "Revange.mp3",
    "Revange 2.mp3",
    "Survival Of Death.mp3",
    "Pile of Total Wreck.mp3",
    "Dessert Storm Ahead.mp3",
    "Industrial Breakdown.mp3",
    "Mental Breakdown.mp3",
    "Metal Gear 2 Solid Snake Chasing the Green Beret Remix.mp3",
    "Metal Gear 2 Solid Snake Freqency 140.85 Remix Version 2026.mp3",
    "Metal Gear 2 Solid Snake Level1 Warning Remix.mp3",
    "Metal Gear 2 Solid Snake Level3 Warning Remix.mp3",
    "Metal Gear 2 Solid Snake Reprieve of The Doctor Remix.mp3",
    "Operation Stealth Destruction.mp3",
    "Takin' On The Shagohod Remake.mp3"
];

// ==================== STATE ====================
let currentIndex = 0;
let radioMode = false;
let loopCurrent = false;

// ==================== DOM ELEMENTS ====================
const audio = document.getElementById("audioPlayer");
const playPauseBtn = document.getElementById("playPauseBtn");
const songSelect = document.getElementById("songSelect");
const progress = document.getElementById("progress");
const timeLabel = document.getElementById("timeLabel");
const durationLabel = document.getElementById("durationLabel");
const volumeSlider = document.getElementById("volumeSlider");
const downloadBtn = document.getElementById("downloadBtn");
const loopBtn = document.getElementById("loopBtn");
const radioToggle = document.getElementById("radioToggle");
const currentSongEl = document.getElementById("currentSong");
const themeBtn = document.getElementById("themeBtn");

// Visualizer Elements
const visualizerOverlay = document.getElementById('visualizerOverlay');
const visualizerBtn = document.getElementById('visualizerBtn');
const closeVisualizer = document.getElementById('closeVisualizer');
const canvas = document.getElementById('visualizerCanvas');
const ctx = canvas.getContext('2d');
const modeBtns = document.querySelectorAll('.mode-btn');
const vizPlayPauseBtn = document.getElementById('vizPlayPauseBtn');

// Audio Context for Visualizer
let audioContext = null;
let analyser = null;
let bufferLength = 0;
let dataArray = null;
let fadeDataArray = null;
let animationId = null;
let vizMode = 2;

const logoImg = new Image();
logoImg.src = BASE_URL + "DogVenomsnakeLogo.png";

// ==================== PWA INSTALL ====================
let deferredPrompt;
const installBanner = document.getElementById('installBanner');
const installBtn = document.getElementById('installBtn');
const dismissBtn = document.getElementById('dismissBtn');

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBanner.style.display = 'flex';
});

installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('Install outcome:', outcome);
        deferredPrompt = null;
    }
    installBanner.style.display = 'none';
});

dismissBtn.addEventListener('click', () => {
    installBanner.style.display = 'none';
});

// Register Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.error('SW registration failed:', err));
    });
}

// ==================== THEME ====================
function toggleTheme() {
    const html = document.documentElement;
    const isLight = html.getAttribute('data-theme') === 'light';
    html.setAttribute('data-theme', isLight ? 'dark' : 'light');
    themeBtn.textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('playerTheme', isLight ? 'dark' : 'light');
}
themeBtn.addEventListener('click', toggleTheme);

// ==================== AUDIO CONTEXT ====================
function initAudioContext() {
    if (audioContext) return;
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    fadeDataArray = new Uint8Array(bufferLength);
    const source = audioContext.createMediaElementSource(audio);
    source.connect(analyser);
    analyser.connect(audioContext.destination);
}

function resumeAudioContext() {
    if (!audioContext) initAudioContext();
    if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
    }
}

// ==================== PLAYER FUNCTIONS ====================
function loadSong(index) {
    currentIndex = index;
    const fileName = songs[index];
    const encodedFileName = encodeURIComponent(fileName);
    audio.src = BASE_URL + encodedFileName;
    songSelect.value = index;
    downloadBtn.href = BASE_URL + encodedFileName;
    downloadBtn.setAttribute("download", fileName);
    currentSongEl.textContent = "‚ñ∂ " + songSelect.options[index].text;
}

function togglePlay() {
    resumeAudioContext();
    if (audio.paused || audio.ended) {
        audio.play().then(() => {
            playPauseBtn.textContent = "‚è∏";
            vizPlayPauseBtn.textContent = "‚è∏";
        }).catch(e => console.error("Play error:", e));
    } else {
        audio.pause();
        playPauseBtn.textContent = "‚ñ∂";
        vizPlayPauseBtn.textContent = "‚ñ∂";
    }
}

function nextSong() {
    if (radioMode) {
        loadSong(Math.floor(Math.random() * songs.length));
    } else {
        loadSong((currentIndex + 1) % songs.length);
    }
    togglePlay();
}

function prevSong() {
    if (radioMode) return;
    loadSong((currentIndex - 1 + songs.length) % songs.length);
    togglePlay();
}

function stopSong() {
    audio.pause();
    audio.currentTime = 0;
    playPauseBtn.textContent = "‚ñ∂";
    vizPlayPauseBtn.textContent = "‚ñ∂";
}

function toggleRadioMode() {
    radioMode = !radioMode;
    if (radioMode) {
        loopCurrent = false;
        updateLoopButtonState();
        loadSong(Math.floor(Math.random() * songs.length));
        togglePlay();
        radioToggle.textContent = "üéß Radio aus";
        radioToggle.classList.add('active');
    } else {
        updateLoopButtonState();
        radioToggle.textContent = "üéß Radio-Modus";
        radioToggle.classList.remove('active');
    }
}

function toggleLoop() {
    if (radioMode) return;
    loopCurrent = !loopCurrent;
    loopBtn.classList.toggle("active", loopCurrent);
}

function updateLoopButtonState() {
    if (radioMode) {
        loopCurrent = false;
        loopBtn.classList.remove("active");
        loopBtn.disabled = true;
    } else {
        loopBtn.disabled = false;
    }
}

function formatTime(time) {
    if (isNaN(time)) return "0:00";
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60).toString().padStart(2, "0");
    return minutes + ":" + seconds;
}

// ==================== EVENT LISTENERS ====================
playPauseBtn.addEventListener('click', togglePlay);
document.getElementById('nextBtn').addEventListener('click', nextSong);
document.getElementById('prevBtn').addEventListener('click', prevSong);
document.getElementById('stopBtn').addEventListener('click', stopSong);
loopBtn.addEventListener('click', toggleLoop);
radioToggle.addEventListener('click', toggleRadioMode);

songSelect.addEventListener('change', () => {
    resumeAudioContext();
    loadSong(parseInt(songSelect.value));
    togglePlay();
});

audio.addEventListener("timeupdate", () => {
    if (!audio.duration) return;
    progress.value = (audio.currentTime / audio.duration) * 100;
    timeLabel.textContent = formatTime(audio.currentTime);
    durationLabel.textContent = formatTime(audio.duration);
});

progress.addEventListener("input", () => {
    audio.currentTime = (progress.value / 100) * audio.duration;
});

volumeSlider.addEventListener("input", () => {
    audio.volume = volumeSlider.value;
});

audio.addEventListener("ended", () => {
    if (loopCurrent && !radioMode) {
        audio.currentTime = 0;
        togglePlay();
    } else {
        nextSong();
    }
});

// ==================== VISUALIZER ====================
function resizeCanvas() {
    const maxW = Math.min(window.innerWidth * 0.92, 800);
    const maxH = window.innerHeight * 0.45;
    const ratio = 16 / 9;
    let w = maxW;
    let h = w / ratio;
    if (h > maxH) { h = maxH; w = h * ratio; }
    canvas.width = Math.floor(w);
    canvas.height = Math.floor(h);
}

function drawRing() {
    ctx.save();
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const logoSize = Math.min(canvas.width, canvas.height) * 0.28;
    
    if (logoImg.complete) {
        ctx.shadowBlur = 25;
        ctx.shadowColor = 'rgba(0,255,255,0.5)';
        ctx.drawImage(logoImg, centerX - logoSize/2, centerY - logoSize/2, logoSize, logoSize);
    }
    
    const ringRadius = logoSize * 0.55;
    ctx.beginPath();
    ctx.arc(centerX, centerY, ringRadius, 0, Math.PI * 2);
    ctx.lineWidth = 4;
    ctx.strokeStyle = 'hsla(200, 100%, 70%, 0.4)';
    ctx.shadowBlur = 20;
    ctx.shadowColor = 'rgba(0, 255, 255, 0.6)';
    ctx.stroke();
    
    const rayCount = 48;
    for (let i = 0; i < rayCount; i++) {
        const angle = (i / rayCount) * Math.PI * 2;
        const freqIndex = Math.floor((i / rayCount) * bufferLength);
        const amp = fadeDataArray[freqIndex] / 255;
        const rayLength = amp * (ringRadius * 0.5);
        
        const innerX = centerX + Math.cos(angle) * ringRadius;
        const innerY = centerY + Math.sin(angle) * ringRadius;
        const outerX = centerX + Math.cos(angle) * (ringRadius + rayLength);
        const outerY = centerY + Math.sin(angle) * (ringRadius + rayLength);
        
        const hue = 180 + (i * 5) % 180;
        ctx.strokeStyle = `hsla(${hue}, 100%, ${60 + amp * 40}%, ${0.7 + amp * 0.3})`;
        ctx.lineWidth = 2 + amp * 5;
        ctx.shadowBlur = 10 + amp * 20;
        ctx.shadowColor = `hsla(${hue}, 100%, 80%, 0.6)`;
        
        ctx.beginPath();
        ctx.moveTo(innerX, innerY);
        ctx.lineTo(outerX, outerY);
        ctx.stroke();
    }
    ctx.restore();
}

function drawWaveform() {
    const baseY = canvas.height - 30;
    ctx.beginPath();
    ctx.moveTo(0, baseY);
    const sliceWidth = canvas.width / bufferLength;
    let x = 0;
    
    for (let i = 0; i < bufferLength; i++) {
        let v = fadeDataArray[i] / 128.0;
        const y = baseY - (v * canvas.height * 0.4);
        ctx.lineTo(x, y);
        x += sliceWidth;
    }
    ctx.lineTo(canvas.width, baseY);
    ctx.closePath();
    
    const gradient = ctx.createLinearGradient(0, baseY, 0, baseY - canvas.height * 0.4);
    gradient.addColorStop(0, 'rgba(0, 255, 255, 0.7)');
    gradient.addColorStop(0.5, 'rgba(145, 70, 255, 0.5)');
    gradient.addColorStop(1, 'rgba(0, 255, 255, 0.2)');
    ctx.fillStyle = gradient;
    ctx.fill();
    ctx.strokeStyle = '#00ffff';
    ctx.lineWidth = 3;
    ctx.shadowBlur = 20;
    ctx.shadowColor = '#00ffff';
    ctx.stroke();
}

function drawBars() {
    const barWidth = (canvas.width / bufferLength) * 1.5;
    let x = 10;
    for (let i = 0; i < bufferLength; i++) {
        const height = (fadeDataArray[i] / 255) * (canvas.height * 0.8);
        ctx.fillStyle = `hsl(${190 + (i * 1.4)}, 100%, 65%)`;
        ctx.fillRect(x, canvas.height - height - 40, barWidth, height);
        x += barWidth + 3;
    }
}

function drawLightning() {
    if (audio.paused || audio.ended) return;
    const bass = Math.max(...fadeDataArray.slice(0,30)) / 255;
    ctx.fillStyle = `rgba(0,255,255,${bass * 0.06})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    const numBolts = 2 + Math.floor(bass * 6);
    for (let b = 0; b < numBolts; b++) {
        let x = 20 + Math.random() * (canvas.width - 40);
        let y = 0;
        ctx.strokeStyle = `hsl(195, 100%, ${60 + bass * 25}%)`;
        ctx.lineWidth = 1.5 + bass * 5;
        ctx.shadowBlur = 20 + bass * 25;
        ctx.shadowColor = 'rgba(160,255,255,0.6)';
        ctx.beginPath();
        ctx.moveTo(x, y);
        const steps = 6 + Math.floor(bass * 4);
        for (let s = 1; s < steps; s++) {
            y += canvas.height / steps * (0.7 + Math.random() * 0.4);
            x += (Math.random() - 0.5) * (40 + bass * 100);
            ctx.lineTo(x, y);
        }
        ctx.stroke();
    }
}

function drawVisualizer() {
    animationId = requestAnimationFrame(drawVisualizer);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (audio.paused || audio.ended || audio.currentTime === 0) {
        for (let i = 0; i < bufferLength; i++) {
            fadeDataArray[i] *= 0.95;
            if (fadeDataArray[i] < 1) fadeDataArray[i] = 0;
        }
    } else {
        analyser.getByteFrequencyData(fadeDataArray);
    }
    
    if (vizMode === 0) drawRing();
    else if (vizMode === 1) drawWaveform();
    else if (vizMode === 2) drawBars();
    else drawLightning();
}

function startVisualizer() {
    if (!audioContext) initAudioContext();
    resumeAudioContext();
    resizeCanvas();
    if (!animationId) drawVisualizer();
}

function stopVisualizer() {
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
}

// Visualizer Events
visualizerBtn.addEventListener('click', () => {
    resumeAudioContext();
    visualizerOverlay.classList.add('active');
    startVisualizer();
});

closeVisualizer.addEventListener('click', () => {
    visualizerOverlay.classList.remove('active');
    stopVisualizer();
});

modeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        modeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        vizMode = parseInt(btn.dataset.mode);
    });
});

vizPlayPauseBtn.addEventListener('click', togglePlay);
document.getElementById('vizPrevBtn').addEventListener('click', prevSong);
document.getElementById('vizNextBtn').addEventListener('click', nextSong);

document.addEventListener('keydown', e => {
    if (e.key === "Escape" && visualizerOverlay.classList.contains('active')) {
        closeVisualizer.click();
    }
});

window.addEventListener('resize', () => {
    if (visualizerOverlay.classList.contains('active')) resizeCanvas();
});

// ==================== INIT ====================
window.addEventListener('load', () => {
    const saved = localStorage.getItem('playerTheme');
    if (saved === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        themeBtn.textContent = '‚òÄÔ∏è';
    }
    loadSong(0);
    updateLoopButtonState();
    resizeCanvas();
    volumeSlider.value = 0.5;
    audio.volume = 0.5;
});
</script>

</body>
</html>
