function drawWaveform() {
  const baseY = canvas.height / 2;  // mittig für symmetrische Welle
  ctx.beginPath();
  ctx.moveTo(0, baseY);

  const sliceWidth = canvas.width / bufferLength;  // volle Breite nutzen
  let x = 0;

  for (let i = 0; i < bufferLength; i++) {
    const v = fadeDataArray[i] / 128.0;
    const y = baseY - (v * canvas.height * 0.45);  // Amplitude bleibt gleich

    ctx.lineTo(x, y);
    x += sliceWidth;
  }

  ctx.lineTo(canvas.width, baseY);
  ctx.lineTo(0, baseY);
  ctx.closePath();

  const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
  gradient.addColorStop(0, 'rgba(0, 255, 255, 0.7)');
  gradient.addColorStop(0.5, 'rgba(145, 70, 255, 0.5)');
  gradient.addColorStop(1, 'rgba(0, 255, 255, 0.2)');

  ctx.fillStyle = gradient;
  ctx.fill();

  ctx.strokeStyle = '#00ffff';
  ctx.lineWidth = 4 + Math.max(...fadeDataArray) / 255 * 6;
  ctx.shadowBlur = 25;
  ctx.shadowColor = '#00ffff';
  ctx.stroke();
}

function drawBars() {
  const barWidth = canvas.width / bufferLength;  // volle Breite, kein Padding
  let x = 0;

  for (let i = 0; i < bufferLength; i++) {
    const height = (fadeDataArray[i] / 255) * canvas.height * 0.85;  // fast volle Höhe

    const gradient = ctx.createLinearGradient(x, canvas.height - height, x, canvas.height);
    gradient.addColorStop(0, `hsl(${190 + (i * 1.4)}, 100%, 65%)`);
    gradient.addColorStop(1, `hsl(${190 + (i * 1.4)}, 100%, 40%)`);

    ctx.fillStyle = gradient;
    ctx.fillRect(x, canvas.height - height, barWidth - 1, height);  // -1 für minimalen Abstand

    x += barWidth;
  }
}

function drawLightning() {
  if (audio.paused || audio.ended || !audio.duration || audio.currentTime === 0) return;

  const bass = Math.max(...fadeDataArray.slice(0,40)) / 255;
  ctx.fillStyle = `rgba(0,255,255,${bass * 0.08})`;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const numBolts = 3 + Math.floor(bass * 10);  // mehr Blitze für volle Fläche
  for (let i = 0; i < numBolts; i++) {
    let x = Math.random() * canvas.width;  // von ganz links bis ganz rechts
    let y = 0;

    ctx.strokeStyle = `hsl(195, 100%, ${60 + bass * 25}%)`;
    ctx.lineWidth = 1.8 + bass * 8;
    ctx.shadowBlur = 30 + bass * 40;
    ctx.shadowColor = 'rgba(160,255,255,0.7)';

    ctx.beginPath();
    ctx.moveTo(x, y);

    const steps = 10 + Math.floor(bass * 6);
    for (let s = 1; s < steps; s++) {
      y += canvas.height / steps * (0.7 + Math.random() * 0.5);
      x += (Math.random() - 0.5) * (80 + bass * 180);  // mehr horizontale Bewegung
      ctx.lineTo(x, y);
    }

    ctx.stroke();
  }
}
