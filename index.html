<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- PWA Essentials -->
<meta name="theme-color" content="#9146ff">
<meta name="background-color" content="#000033">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="android-launchericon-192-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="icon" type="image/x-icon" href="favicon.ico">

<title>VenomSnake Musikplayer</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');

:root {
  --accent: #00ffff;
  --accent-dark: #9146ff;
  --bg-dark: rgba(0,0,50,0.85);
  --bg-light: rgba(245,245,255,0.88);
  --text-dark: #f0f0ff;
  --text-light: #1a1a40;
}

body {
  margin: 0;
  padding: 0;
  font-family: 'Orbitron', sans-serif;
  background: url("musicbackground.png") no-repeat center center fixed;
  background-size: cover;
  color: var(--text-dark);
  text-align: center;
  overflow-y: auto;
  overflow-x: hidden;
  touch-action: manipulation; /* Bessere Touch-Performance */
}

header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: clamp(8px, 3vw, 12px) clamp(12px, 4vw, 24px);
  box-sizing: border-box;
  z-index: 1000;
}

header .logo-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

header .logo-container img {
  height: clamp(35px, 8vw, 45px);
  object-fit: contain;
}

header .logo-container span {
  font-size: clamp(18px, 5vw, 24px);
  font-weight: bold;
  color: #9146ff;
  text-shadow: 0px 0px 8px #00ffff;
}

header nav ul {
  list-style: none;
  display: flex;
  gap: clamp(12px, 3vw, 20px);
  margin: 0;
  padding: 0;
}

header nav ul li a {
  color: #ffffff;
  font-weight: bold;
  text-decoration: none;
  font-size: clamp(14px, 3.5vw, 16px);
  transition: 0.3s;
}

header nav ul li a:hover {
  color: #88f0ff;
  text-shadow: 0 0 6px #88f0ff;
}

#overlay {
  background: var(--bg-dark);
  width: 100%;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: clamp(80px, 15vh, 100px) clamp(12px, 4vw, 24px) clamp(20px, 5vh, 40px);
  box-sizing: border-box;
}

h1 {
  font-size: clamp(24px, 8vw, 38px);
  margin: 0 0 8px 0;
  color: #ffffff;
  text-shadow: 0 0 12px #00ffff, 0 0 24px #000044;
}

#infoText {
  margin-top: 8px;
  font-size: clamp(14px, 3.5vw, 16px);
  color: #c0c0ff;
  max-width: 90%;
}

audio {
  width: 100%;
  max-width: 90vw;
  margin-top: 16px;
}

button, select, #downloadBtn {
  margin: 6px;
  padding: clamp(10px, 3vw, 12px) clamp(12px, 4vw, 16px);
  font-size: clamp(14px, 4vw, 16px);
  border: 2px solid var(--accent);
  border-radius: 6px;
  background: rgba(0,0,50,0.8);
  color: #fff;
  cursor: pointer;
  transition: 0.3s;
  touch-action: manipulation;
}

button:hover, #downloadBtn:hover, select:hover {
  border-color: var(--accent-dark);
  background: rgba(20,20,80,0.9);
  color: var(--accent);
}

button:disabled, button:disabled:hover {
  opacity: 0.45;
  cursor: not-allowed;
  border-color: #555;
  color: #888;
  background: rgba(0,0,30,0.7);
}

#songControls, #controls, #progressContainer {
  margin-top: 12px;
  display: flex;
  gap: clamp(8px, 2vw, 12px);
  flex-wrap: wrap;
  justify-content: center;
  width: 100%;
  max-width: 95vw;
}

#progress {
  -webkit-appearance: none;
  appearance: none;
  width: clamp(200px, 70vw, 300px);
  height: 10px;
  border-radius: 5px;
  background: linear-gradient(90deg, var(--accent), var(--accent-dark));
  cursor: pointer;
  outline: none;
}

#progress::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #ffffff;
  border: 2px solid var(--accent);
  cursor: pointer;
  margin-top: -5px;
}

#progress::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #ffffff;
  border: 2px solid var(--accent);
  cursor: pointer;
}

#volumeContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

#volumeContainer input[type="range"] {
  writing-mode: bt-lr;
  -webkit-appearance: slider-vertical;
  width: 8px;
  height: 100px;
}

#infoBox {
  display: flex;
  gap: 20px;
  justify-content: space-between;
  background: rgba(10,10,30,0.9);
  padding: 12px;
  border: 1px solid var(--accent);
  border-radius: 6px;
  max-width: 95vw;
  width: 100%;
  color: #c8c8ff;
  text-align: left;
  flex-wrap: wrap;
  height: clamp(200px, 40vh, 250px);
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--accent) rgba(10,10,30,0.7);
}

#infoBox::-webkit-scrollbar { width: 8px; }
#infoBox::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: 4px; }
#infoBox::-webkit-scrollbar-track { background: rgba(10,10,30,0.7); }

#infoBox .infoColumn {
  flex: 1;
  min-width: 180px;
}

#infoBox .infoColumn h3 {
  margin-top: 0;
  margin-bottom: 8px;
  color: var(--accent);
}

/* Loop-Button */
.loop-btn {
  width: 38px;
  height: 38px;
  font-size: 1.5rem;
  padding: 0;
  border: 2px solid var(--accent);
  border-radius: 50%;
  background: rgba(0,0,50,0.7);
  color: #a0f0ff;
  cursor: pointer;
  transition: all 0.25s;
}

.loop-btn:hover:not(:disabled) {
  background: rgba(20,20,80,0.9);
  color: var(--accent);
  border-color: var(--accent-dark);
}

.loop-btn.active {
  color: #ffdd00;
  background: rgba(80,60,0,0.5);
  border-color: #ffdd00;
  box-shadow: 0 0 12px #ffdd00aa;
}

/* Light Mode */
[data-theme="light"] {
  --bg-dark: var(--bg-light);
  --text-dark: var(--text-light);
}

[data-theme="light"] header { background: rgba(255,255,255,0.75); }
[data-theme="light"] #infoText { color: #3a3a70; }
[data-theme="light"] h1, [data-theme="light"] #currentSong { color: #1a1a40; text-shadow: 0 0 8px rgba(65,105,225,0.5); }

/* VISUALIZER */
#visualizerOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(3,3,25,0.97);
  backdrop-filter: blur(14px);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

#visualizerOverlay.active {
  display: flex;
}

#visualizerCanvas {
  border-radius: 24px;
  box-shadow: 0 0 60px #00ffff88, 0 0 120px #9146ff55;
  background: #00000033;
  max-width: 96vw;
  max-height: 60vh;
  width: 100%;
  height: auto;
}

.viz-mode-buttons, #vizControls {
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-top: 15px;
}

/* Mobile-Optimierungen ‚Äì alle Screens */
@media (max-width: 600px) {
  header {
    padding: 8px 16px;
    flex-wrap: wrap;
  }
  header nav ul {
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  #overlay {
    padding: 70px 12px 40px;
  }
  #songControls, #controls, #progressContainer {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  #progress {
    width: 100%;
  }
  button, select, #downloadBtn {
    width: 100%;
    padding: 14px;
    font-size: 1.1rem;
  }
  #volumeContainer {
    flex-direction: row;
    justify-content: center;
    gap: 20px;
  }
  #volumeContainer input[type="range"] {
    width: 150px;
    height: 8px;
    writing-mode: horizontal-tb !important;
    -webkit-appearance: slider-horizontal !important;
  }
  #infoBox {
    flex-direction: column;
    height: auto;
    max-height: 50vh;
  }
  #visualizerCanvas {
    max-height: 50vh;
  }
}

@media (max-width: 480px) {
  h1 { font-size: clamp(20px, 7vw, 28px); }
  #infoText { font-size: 14px; }
  .viz-header h2 { font-size: 1.8rem; }
}

@media (max-width: 360px) {
  header .logo-container span { font-size: 18px; }
  button, select { font-size: 1rem; padding: 12px; }
}
</style>
</head>
<body>

<header>
  <div class="logo-container">
    <img src="DogVenomsnakeLogo.png" alt="VenomSnake Logo">
    <span>VENOM<span class="snake">SNŒõKE</span></span>
  </div>
  <nav>
    <ul>
      <li><a href="index.html">Startseite</a></li>
      <li><a href="donation.html">Spenden</a></li>
      <li><a href="kontakt.html">Kontakt</a></li>
      <li><button id="visualizerBtn">üéµ Visualizer</button></li>
    </ul>
  </nav>
  <button id="themeBtn" style="padding: 6px 12px; font-size: 1.2rem; background: rgba(145,70,255,0.3); border: 1px solid #9146ff; border-radius: 6px; color: white; cursor: pointer;">
    üåô
  </button>
</header>

<div id="overlay">
  <h1>VenomSnake_Twitch¬¥s Musikplayer</h1>
  <div id="infoText">Hier lade ich meine Musik, die ich mit Suno.com erstellt habe, hoch. Diese kannst du dir anh√∂ren und herunterladen.</div>
  <h2 id="currentSong">‚ñ∂ Kein Song ausgew√§hlt</h2>
  <audio id="audioPlayer" crossorigin="anonymous"></audio>

  <div id="songControls">
    <select id="songSelect" onchange="selectSong()">
      <option value="0">Snake Eater VenomSnake_Twitch Mix</option>
      <option value="1">Ghost Town by VenomSnake_Twitch</option>
      <option value="2">Wreckfest</option>
      <option value="3">In The Air Tonight(VenomSnake_Twitch)</option>
      <option value="4">Paradies City</option>
      <option value="5">Parasit√§res Bewustsein</option>
      <option value="6">Still Alive (Voiced)</option>
      <option value="7">Yu-Gi-Oh! Master Duel Solo Gate Theme Synth Mix</option>
      <option value="8">Bye Bye Beautiful</option>
      <option value="9">Kettenreaktion (Cover)</option>
      <option value="10">Stra√üe der Verdammnis</option>
      <option value="11">Syphon Filter Synth Mix</option>
      <option value="12">VenomSnake Mode Intro song</option>
      <option value="13">Hell March [Retaliation Cover]</option>
      <option value="14">Dance hall Dance(Cover)</option>
      <option value="15">Resident Evil 5 Desperate Escape Main Theme Music(Remix)</option>
      <option value="16">Bleed out My Frend</option>
      <option value="17">Revange</option>
      <option value="18">Revange 2</option>
      <option value="19">Survival Of Death</option>
      <option value="20">Pile of Total Wreck</option>
      <option value="21">Dessert Storm Ahead</option>
      <option value="22">Industrial Breakdown</option>
      <option value="23">Mental Breakdown</option>
      <option value="24">Metal Gear 2 Solid Snake Chasing the Green Beret Remix</option>
      <option value="25">Metal Gear 2 Solid Snake Freqency 140.85 Remix Version 2026</option>
      <option value="26">Metal Gear 2 Solid Snake Level1 Warning Remix</option>
      <option value="27">Metal Gear 2 Solid Snake Level3 Warning Remix</option>
      <option value="28">Metal Gear 2 Solid Snake Reprieve of The Doctor Remix</option>
      <option value="29">Operation Stealth Destruction</option>
      <option value="30">Takin' On The Shagohod Remake</option>
    </select>
    <a id="downloadBtn" href="" download>Download</a>
    <div id="volumeContainer">
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
      <span>Lautst√§rke</span>
    </div>
  </div>

  <div id="progressContainer">
    <span id="timeLabel">0:00</span>
    <input type="range" id="progress" min="0" max="100" value="0">
    <button id="loopBtn" type="button" title="Aktuellen Song wiederholen (nicht im Radio-Modus m√∂glich)" class="loop-btn">üîÅ</button>
    <span id="durationLabel">0:00</span>
  </div>

  <div id="controls">
    <button onclick="prevSong()">‚èÆ Vorheriger</button>
    <button id="playPauseBtn" onclick="togglePlay()">‚ñ∂ Play</button>
    <button onclick="stopSong()">‚èπ Stop</button>
    <button onclick="nextSong()">‚è≠ N√§chster</button>
    <button onclick="toggleFullscreen()">Vollbild</button>
    <button id="radioToggle" onclick="toggleRadioMode()">üéß Radio-Modus</button>
  </div>

  <div id="infoBox">
    <div class="infoColumn">
      <h3>Neue Songs Sind Da!</h3>
      <p>Bleed out My Frend</p>
      <p>Revange</p>
      <p>Revange 2</p>
      <p>Survival Of Death</p>
      <p>Pile of Total Wreck</p>
      <p>Industrial Breakdown</p>
      <p>Mental Breakdown</p>
      <p>Operation Stealth Destruction</p>
      <p>Dessert Storm Ahead</p>
      <p>Metal Gear 2 Solid Snake Chasing the Green Beret Remix</p>
      <p>Metal Gear 2 Solid Snake Freqency 140.85 Remix Version 2026</p>
      <p>Metal Gear 2 Solid Snake Level1 Warning Remix</p>
      <p>Metal Gear 2 Solid Snake Level3 Warning Remix</p>
      <p>Metal Gear 2 Solid Snake Reprieve of The Doctor Remix</p>
      <p>Takin' On The Shagohod Remake</p>
    </div>
    <div class="infoColumn">
      <h3>Bald Erscheinende Songs</h3>
      <p>Metal Gear 2 Solid Snake Frequency 140.85</p>
      <p>Weitere Projekte in Planung...</p>
    </div>
  </div>
</div>

<!-- VISUALIZER OVERLAY -->
<div id="visualizerOverlay">
  <div class="viz-header"><h2>VENOM VISUALIZER</h2></div>
  <button id="closeVisualizer" class="close-viz-btn">‚úï</button>

  <canvas id="visualizerCanvas"></canvas>

  <div class="viz-mode-buttons">
    <button class="mode-btn" data-mode="0">RING</button>
    <button class="mode-btn" data-mode="1">WAVE</button>
    <button class="mode-btn active" data-mode="2">BARS</button>
    <button class="mode-btn" data-mode="3">‚ö° BLITZ</button>
  </div>

  <div id="vizControls">
    <button onclick="prevSong()" class="viz-btn">‚èÆ</button>
    <button id="vizPlayPauseBtn" onclick="togglePlay()" class="viz-btn">‚ñ∂</button>
    <button onclick="nextSong()" class="viz-btn">‚è≠</button>
    <select id="vizSongSelect" onchange="selectSongFromViz()" class="viz-select"></select>
  </div>

  <div id="vizVersion">Visualizer v4.5</div>
</div>

<script>
// Service Worker Registrierung
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => console.log('Service Worker registriert mit Scope:', registration.scope))
      .catch(error => console.error('Service Worker Registrierung fehlgeschlagen:', error));
  });
}

// Songs-Liste und BASE_URL
const songs = [
  "Snake Eater VenomSnake_Twitch Mix.mp3",
  "Ghost Town by VenomSnake_Twitch.mp3",
  "Wreckfest.mp3",
  "In The Air Tonight(VenomSnake_Twitch).mp3",
  "Paradies City.mp3",
  "Parasit√§res Bewustsein.mp3",
  "Still Alive (Voiced).mp3",
  "Yu-Gi-Oh! Master Duel Solo Gate Theme Synth Mix.mp3",
  "ByeByeBeautiful.mp3",
  "Kettenreaktion (Cover).mp3",
  "Strasse der Verdammnis.mp3",
  "Syphon Filter Synth Mix.mp3",
  "VenomSnake Mode Intro song.mp3",
  "Hell March [Retaliation Cover].mp3",
  "Dance hall Dance(Cover).mp3",
  "Resident Evil 5 Desperate Escape Main Theme Music(Remix).mp3",
  "Bleed out My Frend.mp3",
  "Revange.mp3",
  "Revange 2.mp3",
  "Survival Of Death.mp3",
  "Pile of Total Wreck.mp3",
  "Dessert Storm Ahead.mp3",
  "Industrial Breakdown.mp3",
  "Mental Breakdown.mp3",
  "Metal Gear 2 Solid Snake Chasing the Green Beret Remix.mp3",
  "Metal Gear 2 Solid Snake Freqency 140.85 Remix Version 2026.mp3",
  "Metal Gear 2 Solid Snake Level1 Warning Remix.mp3",
  "Metal Gear 2 Solid Snake Level3 Warning Remix.mp3",
  "Metal Gear 2 Solid Snake Reprieve of The Doctor Remix.mp3",
  "Operation Stealth Destruction.mp3",
  "Takin' On The Shagohod Remake.mp3"
];

const BASE_URL = "https://raw.githubusercontent.com/VenomSnakeTwitch/VenomSnake_Twitch-Webseite/main/";

let currentIndex = 0;
let radioMode = false;
let loopCurrent = false;

const audio = document.getElementById("audioPlayer");
const playPauseBtn = document.getElementById("playPauseBtn");
const songSelect = document.getElementById("songSelect");
const progress = document.getElementById("progress");
const timeLabel = document.getElementById("timeLabel");
const durationLabel = document.getElementById("durationLabel");
const volumeSlider = document.getElementById("volumeSlider");
const downloadBtn = document.getElementById("downloadBtn");
const loopBtn = document.getElementById("loopBtn");
const radioToggle = document.getElementById("radioToggle");

// VISUALIZER
const visualizerOverlay = document.getElementById('visualizerOverlay');
const visualizerBtn = document.getElementById('visualizerBtn');
const closeVisualizer = document.getElementById('closeVisualizer');
const canvas = document.getElementById('visualizerCanvas');
const ctx = canvas.getContext('2d');
const modeBtns = document.querySelectorAll('.mode-btn');
const vizPlayPauseBtn = document.getElementById('vizPlayPauseBtn');
const vizSongSelect = document.getElementById('vizSongSelect');

let audioContext = null;
let analyser = null;
let bufferLength = 0;
let dataArray = null;
let fadeDataArray = null;
let animationId = null;
let vizMode = 2;

const logoImg = new Image();
logoImg.src = "DogVenomsnakeLogo.png";

// AudioContext & Analyser
function initAudioContext() {
  if (audioContext) return;
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 512;
  bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
  fadeDataArray = new Uint8Array(bufferLength);
  const source = audioContext.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(audioContext.destination);
}

// Resume AudioContext
function resumeAudioContext() {
  if (!audioContext) initAudioContext();
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
}

// Play/Pause
function togglePlay() {
  resumeAudioContext();
  if (audio.paused || audio.ended) {
    audio.play().then(() => {
      playPauseBtn.textContent = "‚è∏ Pause";
      if (vizPlayPauseBtn) vizPlayPauseBtn.textContent = "‚è∏";
    }).catch(e => alert("Play fehlgeschlagen: " + e.name));
  } else {
    audio.pause();
    playPauseBtn.textContent = "‚ñ∂ Play";
    if (vizPlayPauseBtn) vizPlayPauseBtn.textContent = "‚ñ∂";
  }
}

// Load Song
function loadSong(index) {
  currentIndex = index;
  const fileName = songs[index];
  const safeName = encodeURIComponent(fileName);
  const url = BASE_URL + safeName;

  audio.src = url;
  songSelect.value = index;
  if (vizSongSelect) vizSongSelect.value = index;
  downloadBtn.href = url;
  downloadBtn.setAttribute("download", fileName);
  document.getElementById("currentSong").textContent = "‚ñ∂ " + songSelect.options[index].text;
}

// Select Song
function selectSong() {
  resumeAudioContext();
  loadSong(parseInt(songSelect.value));
  togglePlay();
}

function selectSongFromViz() {
  resumeAudioContext();
  loadSong(parseInt(vizSongSelect.value));
  togglePlay();
}

// Next / Prev / Stop / Radio / Fullscreen
function nextSong() {
  if (radioMode) loadSong(Math.floor(Math.random() * songs.length));
  else loadSong((currentIndex + 1) % songs.length);
  togglePlay();
}

function prevSong() {
  if (radioMode) return;
  loadSong((currentIndex - 1 + songs.length) % songs.length);
  togglePlay();
}

function stopSong() {
  audio.pause();
  audio.currentTime = 0;
  playPauseBtn.textContent = "‚ñ∂ Play";
  if (vizPlayPauseBtn) vizPlayPauseBtn.textContent = "‚ñ∂";
}

function toggleRadioMode() {
  radioMode = !radioMode;
  radioToggle.textContent = radioMode ? "üéß Radio aus" : "üéß Radio-Modus";
  if (radioMode) nextSong();
}

function toggleFullscreen() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

// Loop Button
loopBtn.addEventListener("click", () => {
  if (radioMode) return;
  loopCurrent = !loopCurrent;
  loopBtn.classList.toggle("active", loopCurrent);
});

// Progress & Time
audio.addEventListener("timeupdate", () => {
  if (!audio.duration) return;
  progress.value = (audio.currentTime / audio.duration) * 100;
  timeLabel.textContent = formatTime(audio.currentTime);
  durationLabel.textContent = formatTime(audio.duration);
});

progress.addEventListener("input", () => {
  if (audio.duration) audio.currentTime = (progress.value / 100) * audio.duration;
});

volumeSlider.addEventListener("input", () => audio.volume = volumeSlider.value);

function formatTime(time) {
  if (isNaN(time)) return "0:00";
  const min = Math.floor(time / 60);
  const sec = Math.floor(time % 60).toString().padStart(2, '0');
  return min + ":" + sec;
}

audio.addEventListener("ended", () => {
  if (loopCurrent && !radioMode) {
    audio.currentTime = 0;
    togglePlay();
  } else {
    nextSong();
  }
});

function updateLoopButtonState() {
  loopBtn.disabled = radioMode;
  if (radioMode) loopBtn.classList.remove("active");
}

// VISUALIZER
function resizeCanvas() {
  const maxW = Math.min(window.innerWidth * 0.94, 1100);
  const maxH = window.innerHeight * 0.72;
  const ratio = 900 / 620;
  let w = maxW;
  let h = w / ratio;
  if (h > maxH) { h = maxH; w = h * ratio; }
  canvas.width = Math.floor(w);
  canvas.height = Math.floor(h);
}

function drawRing() { /* deine drawRing-Funktion hier komplett einf√ºgen */ }
function drawWaveform() { /* deine drawWaveform-Funktion */ }
function drawBars() { /* deine drawBars-Funktion */ }
function drawLightning() { /* deine drawLightning-Funktion */ }

function drawVisualizer() {
  animationId = requestAnimationFrame(drawVisualizer);
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (audio.paused || audio.ended || audio.currentTime === 0) {
    for (let i = 0; i < bufferLength; i++) fadeDataArray[i] *= 0.95, fadeDataArray[i] < 1 && (fadeDataArray[i] = 0);
  } else {
    analyser.getByteFrequencyData(fadeDataArray);
  }
  if (vizMode === 0) drawRing();
  else if (vizMode === 1) drawWaveform();
  else if (vizMode === 2) drawBars();
  else drawLightning();
}

function startVisualizer() {
  if (!audioContext) initAudioContext();
  resumeAudioContext();
  resizeCanvas();
  if (!animationId) drawVisualizer();
}

function stopVisualizer() {
  if (animationId) cancelAnimationFrame(animationId), animationId = null;
}

function populateVizSongSelect() {
  vizSongSelect.innerHTML = songSelect.innerHTML;
  vizSongSelect.value = currentIndex;
}

// VISUALIZER EVENTS
visualizerBtn.addEventListener('click', () => {
  resumeAudioContext();
  if (audio.paused) togglePlay();
  visualizerOverlay.classList.add('active');
  populateVizSongSelect();
  startVisualizer();
});

closeVisualizer.addEventListener('click', () => {
  visualizerOverlay.classList.remove('active');
  stopVisualizer();
});

modeBtns.forEach(btn => btn.addEventListener('click', () => {
  modeBtns.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  vizMode = parseInt(btn.dataset.mode);
}));

// START
window.addEventListener('load', () => {
  const saved = localStorage.getItem('playerTheme');
  if (saved === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
  }
  loadSong(0);
  updateLoopButtonState();
  populateVizSongSelect();
  resizeCanvas();
  volumeSlider.value = 0.5;
});
</script>
</body>
</html>
