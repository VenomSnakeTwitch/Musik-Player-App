<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- PWA Essentials -->
<meta name="theme-color" content="#9146ff">
<meta name="background-color" content="#000033">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="android-launchericon-192-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<title>VenomSnake Musikplayer</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');
body {
    margin: 0;
    padding: 0;
    font-family: 'Orbitron', sans-serif;
    background: url("musicbackground.png") no-repeat center center fixed;
    background-size: cover;
    color: #f0f0ff;
    text-align: center;
    overflow-y: auto;
    overflow-x: hidden;
}
header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 24px;
    box-sizing: border-box;
    z-index: 1000;
}
header .logo-container {
    display: flex;
    align-items: center;
    gap: 10px;
}
header .logo-container img { height: 45px; object-fit: contain; }
header .logo-container span {
    font-size: 24px;
    font-weight: bold;
    color: #9146ff;
    text-shadow: 0px 0px 8px #00ffff;
}
header .logo-container span .snake { color: #00ffff; }
header nav ul {
    list-style: none;
    display: flex;
    gap: 20px;
    margin: 0;
    padding: 0;
}
header nav ul li a {
    color: #ffffff;
    font-weight: bold;
    text-decoration: none;
    transition: 0.3s;
}
header nav ul li a:hover {
    color: #88f0ff;
    text-shadow: 0 0 6px #88f0ff;
}
#overlay {
    background: rgba(0,0,50,0.85);
    width: 100%;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 100px;
    box-sizing: border-box;
}
h1 { font-size: 38px; margin: 0; color: #ffffff; text-shadow: 0 0 12px #00ffff, 0 0 24px #000044; }
#infoText { margin-top: 8px; font-size: 16px; color: #c0c0ff; }
audio { width: 100%; margin-top: 16px; }
button, select, #downloadBtn {
    margin: 8px;
    padding: 10px 16px;
    font-size: 16px;
    border: 2px solid #00ffff;
    border-radius: 6px;
    background: rgba(0,0,50,0.8);
    color: #fff;
    cursor: pointer;
    transition: 0.3s;
}
button:hover, #downloadBtn:hover, select:hover { border-color: #9146ff; background: rgba(20,20,80,0.9); color: #00ffff; }
button:disabled, button:disabled:hover {
    opacity: 0.45;
    cursor: not-allowed;
    border-color: #555;
    color: #888;
    background: rgba(0,0,30,0.7);
    box-shadow: none;
}
#songControls, #controls, #progressContainer { margin-top: 12px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
#progress {
    -webkit-appearance: none;
    appearance: none;
    width: 300px;
    height: 10px;
    border-radius: 5px;
    background: linear-gradient(90deg, #00ffff, #9146ff);
    cursor: pointer;
    outline: none;
}
#progress::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #ffffff;
    border: 2px solid #00ffff;
    cursor: pointer;
    margin-top: -3px;
}
#progress::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: #ffffff; border: 2px solid #00ffff; cursor: pointer; }
#volumeContainer { display: flex; flex-direction: column; align-items: center; }
#volumeContainer input[type="range"] { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 8px; height: 100px; }
#infoBox {
    display: flex;
    gap: 20px;
    justify-content: space-between;
    background: rgba(10,10,30,0.9);
    padding: 12px;
    border: 1px solid #00ffff;
    border-radius: 6px;
    max-width: 600px;
    color: #c8c8ff;
    text-align: left;
    flex-wrap: wrap;
    height: 250px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #00ffff rgba(10,10,30,0.7);
}
#infoBox::-webkit-scrollbar { width: 8px; }
#infoBox::-webkit-scrollbar-thumb { background-color: #00ffff; border-radius: 4px; }
#infoBox::-webkit-scrollbar-track { background: rgba(10,10,30,0.7); }
#infoBox .infoColumn { flex: 1; min-width: 200px; }
#infoBox .infoColumn h3 { margin-top: 0; margin-bottom: 8px; color: #00ffff; }
/* Loop-Button Styling */
.loop-btn {
    width: 38px;
    height: 38px;
    min-width: 38px;
    font-size: 1.5rem;
    line-height: 1;
    padding: 0;
    margin: 0 8px;
    border: 2px solid #00ffff;
    border-radius: 50%;
    background: rgba(0,0,50,0.7);
    color: #a0f0ff;
    cursor: pointer;
    transition: all 0.25s;
}
.loop-btn:hover:not(:disabled) {
    background: rgba(20,20,80,0.9);
    color: #00ffff;
    border-color: #9146ff;
}
.loop-btn.active {
    color: #ffdd00;
    background: rgba(80,60,0,0.5);
    border-color: #ffdd00;
    box-shadow: 0 0 12px #ffdd00aa;
}
#progressContainer {
    gap: 10px;
    align-items: center;
    justify-content: center;
    flex-wrap: nowrap;
    max-width: 520px;
    margin: 20px auto 12px auto;
}
/* Light / Dark Mode Erg√§nzung */
[data-theme="light"] #overlay { background: rgba(245,245,255,0.88); }
[data-theme="light"] header { background: rgba(255,255,255,0.75); }
[data-theme="light"] body { color: #1a1a40; }
[data-theme="light"] #infoText { color: #3a3a70; }
[data-theme="light"] h1, [data-theme="light"] #currentSong { color: #1a1a40; text-shadow: 0 0 8px rgba(65,105,225,0.5); }
[data-theme="light"] button, [data-theme="light"] select, [data-theme="light"] #downloadBtn { background: rgba(230,230,255,0.9); border-color: #4169e1; color: #1a1a40; }
[data-theme="light"] button:hover, [data-theme="light"] #downloadBtn:hover, [data-theme="light"] select:hover { background: rgba(210,210,255,0.95); border-color: #6a0dad; color: #000033; }
[data-theme="light"] .loop-btn { border-color: #4169e1; background: rgba(230,230,255,0.8); color: #1a1a40; }
[data-theme="light"] .loop-btn:hover:not(:disabled) { border-color: #6a0dad; background: rgba(210,210,255,0.9); }
[data-theme="light"] .loop-btn.active { border-color: #cc9900; color: #cc9900; }
[data-theme="light"] #infoBox { background: rgba(240, 240, 255, 0.92); border: 1px solid #4169e1; color: #1a1a40; }
[data-theme="light"] #infoBox h3, [data-theme="light"] #infoBox p { color: #1a1a40; }
/* ==================== VISUALIZER ==================== */
#visualizerOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(3,3,25,0.97); backdrop-filter: blur(14px);
    display: none; flex-direction: column; align-items: center; justify-content: center;
    z-index: 2000;
}
#visualizerOverlay.active { display: flex; }
.viz-header { position: absolute; top: 25px; left: 50%; transform: translateX(-50%); }
.viz-header h2 { margin: 0; font-size: 2.6rem; text-shadow: 0 0 25px #00ffff; color: #00ffff; letter-spacing: 4px; }
.close-viz-btn { position: absolute; top: 25px; right: 40px; font-size: 3rem; background: none; border: none; color: #ff3366; cursor: pointer; transition: all 0.3s; }
.close-viz-btn:hover { transform: rotate(90deg) scale(1.15); }
#visualizerCanvas {
    border-radius: 24px; box-shadow: 0 0 60px #00ffff88, 0 0 120px #9146ff55;
    background: #00000033; max-width: 96vw; max-height: 72vh; width: auto; height: auto;
}
.viz-mode-buttons { margin-top: 25px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
.mode-btn { padding: 10px 24px; font-size: 1.05rem; background: rgba(0,0,60,0.6); border: 2px solid #00ffff; color: #fff; border-radius: 50px; cursor: pointer; transition: all 0.3s; }
.mode-btn:hover { background: rgba(145,70,255,0.4); }
.mode-btn.active { background: linear-gradient(90deg, #9146ff, #00ffff); border-color: #ffffff; box-shadow: 0 0 30px #00ffff; }
#vizControls {
    margin-top: 22px; display: flex; align-items: center; gap: 10px;
    background: rgba(0,0,40,0.92); padding: 10px 18px; border-radius: 50px;
    border: 2px solid #00ffff55; box-shadow: 0 0 40px rgba(0,255,255,0.3);
    flex-wrap: wrap; justify-content: center;
}
.viz-btn { width: 48px; height: 48px; font-size: 1.65rem; display: flex; align-items: center; justify-content: center;
    background: rgba(0,0,60,0.8); border: 3px solid #00ffff; color: #fff; border-radius: 50%; cursor: pointer; transition: all 0.25s;
}
#vizPlayPauseBtn { width: 62px; height: 62px; font-size: 2.15rem; }
.viz-select { padding: 11px 18px; font-size: 0.98rem; background: rgba(0,0,60,0.85); border: 2px solid #00ffff; color: #fff; border-radius: 14px; min-width: 220px; }
/* Versionsnummer */
#vizVersion {
    position: absolute; bottom: 18px; right: 24px; font-size: 0.95rem;
    color: #88f0ff; opacity: 0.7; text-shadow: 0 0 8px #00ffff, 0 0 14px #9146ff;
    pointer-events: none; letter-spacing: 1px; font-weight: bold; z-index: 10;
}
[data-theme="light"] #vizVersion { color: #4169e1; text-shadow: 0 0 6px #4169e1; opacity: 0.8; }
</style>
</head>
<body>
<header>
    <div class="logo-container">
        <img src="DogVenomsnakeLogo.png" alt="VenomSnake Logo">
        <span>VENOM<span class="snake">SNŒõKE</span></span>
    </div>
    <button id="themeBtn" style="padding: 6px 12px; font-size: 1.2rem; background: rgba(145,70,255,0.3); border: 1px solid #9146ff; border-radius: 6px; color: white; cursor: pointer;">
        üåô
    </button>
</header>
<div id="overlay">
    <h1>VenomSnake_Twitch¬¥s Musikplayer</h1>
    <div id="infoText">Hier lade ich meine Musik, die ich mit Suno.com erstellt habe, hoch. Diese kannst du dir anh√∂ren und herunterladen.</div>
    <h2 id="currentSong">‚ñ∂ Kein Song ausgew√§hlt</h2>
    <audio id="audioPlayer" crossorigin="anonymous"></audio>
    <div id="songControls">
        <select id="songSelect" onchange="selectSong()">
            <option value="0">Snake Eater VenomSnake_Twitch Mix</option>
            <option value="1">Ghost Town by VenomSnake_Twitch</option>
            <option value="2">Wreckfest</option>
            <option value="3">In The Air Tonight(VenomSnake_Twitch)</option>
            <option value="4">Paradies City</option>
            <option value="5">Parasit√§res Bewustsein</option>
            <option value="6">Still Alive (Voiced)</option>
            <option value="7">Yu-Gi-Oh! Master Duel Solo Gate Theme Synth Mix</option>
            <option value="8">Bye Bye Beautiful</option>
            <option value="9">Kettenreaktion (Cover)</option>
            <option value="10">Stra√üe der Verdammnis</option>
            <option value="11">Syphon Filter Synth Mix</option>
            <option value="12">VenomSnake Mode Intro song</option>
            <option value="13">Hell March [Retaliation Cover]</option>
            <option value="14">Dance hall Dance(Cover)</option>
            <option value="15">Resident Evil 5 Desperate Escape Main Theme Music(Remix)</option>
            <option value="16">Bleed out My Frend</option>
            <option value="17">Revange</option>
            <option value="18">Revange 2</option>
            <option value="19">Survival Of Death</option>
            <option value="20">Pile of Total Wreck</option>
            <option value="21">Dessert Storm Ahead</option>
            <option value="22">Industrial Breakdown</option>
            <option value="23">Mental Breakdown</option>
            <option value="24">Metal Gear 2 Solid Snake Chasing the Green Beret Remix</option>
            <option value="25">Metal Gear 2 Solid Snake Freqency 140.85 Remix Version 2026</option>
            <option value="26">Metal Gear 2 Solid Snake Level1 Warning Remix</option>
            <option value="27">Metal Gear 2 Solid Snake Level3 Warning Remix</option>
            <option value="28">Metal Gear 2 Solid Snake Reprieve of The Doctor Remix</option>
            <option value="29">Operation Stealth Destruction</option>
            <option value="30">Takin' On The Shagohod Remake</option>
        </select>
        <a id="downloadBtn" href="" download>Download</a>
        <div id="volumeContainer">
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
            <span>Lautst√§rke</span>
        </div>
    </div>
    <div id="progressContainer">
        <span id="timeLabel">0:00</span>
        <input type="range" id="progress" min="0" max="100" value="0">
        <button id="loopBtn" type="button" title="Aktuellen Song wiederholen (nicht im Radio-Modus m√∂glich)" class="loop-btn">üîÅ</button>
        <span id="durationLabel">0:00</span>
    </div>
    <div id="controls">
        <button onclick="prevSong()">‚èÆ Vorheriger</button>
        <button id="playPauseBtn" onclick="togglePlay()">‚ñ∂ Play</button>
        <button onclick="stopSong()">‚èπ Stop</button>
        <button onclick="nextSong()">‚è≠ N√§chster</button>
        <button onclick="toggleFullscreen()">Vollbild</button>
        <button id="radioToggle" onclick="toggleRadioMode()">üéß Radio-Modus</button>
    </div>
<div id="infoBox">
    <div class="infoColumn">
        <h3>Neue Songs Sind Da!</h3>
        <p>Bleed out My Frend</p>
        <p>Revange</p>
        <p>Revange 2</p>
        <p>Survival Of Death</p>
        <p>Pile of Total Wreck</p>
        <p>Industrial Breakdown</p>
        <p>Mental Breakdown</p>
        <p>Operation Stealth Destruction</p>
        <p>Dessert Storm Ahead</p>
        <p>Metal Gear 2 Solid Snake Chasing the Green Beret Remix</p>
        <p>Metal Gear 2 Solid Snake Freqency 140.85 Remix Version 2026</p>
        <p>Metal Gear 2 Solid Snake Level1 Warning Remix</p>
        <p>Metal Gear 2 Solid Snake Level3 Warning Remix</p>
        <p>Metal Gear 2 Solid Snake Reprieve of The Doctor Remix</p>
        <p>Takin' On The Shagohod Remake</p>
    </div>
    <div class="infoColumn">
    <h3>Bald Erscheinende Songs</h3>
    <p>Metal Gear 2 Solid Snake Frequency 140.85</p>
    <p>Weitere Projekte in Planung...</p>
</div>
</div>
</div>
<!-- VISUALIZER OVERLAY -->
<div id="visualizerOverlay">
    <div class="viz-header"><h2>VENOM VISUALIZER</h2></div>
    <button id="closeVisualizer" class="close-viz-btn">‚úï</button>
  
    <canvas id="visualizerCanvas"></canvas>
    <div class="viz-mode-buttons">
        <button class="mode-btn" data-mode="0">RING</button>
        <button class="mode-btn" data-mode="1">WAVE</button>
        <button class="mode-btn active" data-mode="2">BARS</button>
        <button class="mode-btn" data-mode="3">‚ö° BLITZ</button>
    </div>
    <div id="vizControls">
        <button onclick="prevSong()" class="viz-btn">‚èÆ</button>
        <button id="vizPlayPauseBtn" onclick="togglePlay()" class="viz-btn">‚ñ∂</button>
        <button onclick="nextSong()" class="viz-btn">‚è≠</button>
        <select id="vizSongSelect" onchange="selectSongFromViz()" class="viz-select"></select>
    </div>
    <div id="vizVersion">Visualizer v4.5</div>
</div>

<script>
// Service Worker (bleibt gleich)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('Service Worker erfolgreich registriert mit Scope:', registration.scope);
      })
      .catch(error => {
        console.log('Service Worker Registrierung fehlgeschlagen:', error);
      });
  });
}

// Songs und BASE_URL
const songs = [
    "Snake Eater VenomSnake_Twitch Mix.mp3",
    "Ghost Town by VenomSnake_Twitch.mp3",
    "Wreckfest.mp3",
    "In The Air Tonight(VenomSnake_Twitch).mp3",
    "Paradies City.mp3",
    "Parasit√§res Bewustsein.mp3",
    "Still Alive (Voiced).mp3",
    "Yu-Gi-Oh! Master Duel Solo Gate Theme Synth Mix.mp3",
    "ByeByeBeautiful.mp3",
    "Kettenreaktion (Cover).mp3",
    "Strasse der Verdammnis.mp3",
    "Syphon Filter Synth Mix.mp3",
    "VenomSnake Mode Intro song.mp3",
    "Hell March [Retaliation Cover].mp3",
    "Dance hall Dance(Cover).mp3",
    "Resident Evil 5 Desperate Escape Main Theme Music(Remix).mp3",
    "Bleed out My Frend.mp3",
    "Revange.mp3",
    "Revange 2.mp3",
    "Survival Of Death.mp3",
    "Pile of Total Wreck.mp3",
    "Dessert Storm Ahead.mp3",
    "Industrial Breakdown.mp3",
    "Mental Breakdown.mp3",
    "Metal Gear 2 Solid Snake Chasing the Green Beret Remix.mp3",
    "Metal Gear 2 Solid Snake Freqency 140.85 Remix Version 2026.mp3",
    "Metal Gear 2 Solid Snake Level1 Warning Remix.mp3",
    "Metal Gear 2 Solid Snake Level3 Warning Remix.mp3",
    "Metal Gear 2 Solid Snake Reprieve of The Doctor Remix.mp3",
    "Operation Stealth Destruction.mp3",
    "Takin' On The Shagohod Remake.mp3"
];

const BASE_URL = "https://raw.githubusercontent.com/VenomSnakeTwitch/VenomSnake_Twitch-Webseite/main/";

let currentIndex = 0;
let radioMode = false;
let loopCurrent = false;

const audio = document.getElementById("audioPlayer");
const playPauseBtn = document.getElementById("playPauseBtn");
const songSelect = document.getElementById("songSelect");
const progress = document.getElementById("progress");
const timeLabel = document.getElementById("timeLabel");
const durationLabel = document.getElementById("durationLabel");
const volumeSlider = document.getElementById("volumeSlider");
const downloadBtn = document.getElementById("downloadBtn");
const loopBtn = document.getElementById("loopBtn");
const radioToggle = document.getElementById("radioToggle");

// VISUALIZER VARS & FUNCTIONS
const visualizerOverlay = document.getElementById('visualizerOverlay');
const visualizerBtn = document.getElementById('visualizerBtn');
const closeVisualizer = document.getElementById('closeVisualizer');
const canvas = document.getElementById('visualizerCanvas');
const ctx = canvas.getContext('2d');
const modeBtns = document.querySelectorAll('.mode-btn');
const vizPlayPauseBtn = document.getElementById('vizPlayPauseBtn');
const vizSongSelect = document.getElementById('vizSongSelect');

let audioContext = null;
let analyser = null;
let bufferLength = 0;
let dataArray = null;
let fadeDataArray = null;
let animationId = null;
let vizMode = 2; // BARS als Standard

const logoImg = new Image();
logoImg.src = "DogVenomsnakeLogo.png";

function initAudioContext() {
    if (audioContext) return;
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    fadeDataArray = new Uint8Array(bufferLength);
    const source = audioContext.createMediaElementSource(audio);
    source.connect(analyser);
    analyser.connect(audioContext.destination);
    console.log("AudioContext initialisiert");
}

function resumeAudioContext() {
    if (!audioContext) initAudioContext();
    if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
            console.log("AudioContext resumed");
        }).catch(e => console.error("Resume fehlgeschlagen:", e));
    }
}

function togglePlay() {
    resumeAudioContext();
    if (audio.paused || audio.ended) {
        audio.play().then(() => {
            playPauseBtn.textContent = "‚è∏ Pause";
            vizPlayPauseBtn.textContent = "‚è∏";
            console.log("Audio gestartet");
        }).catch(e => {
            console.error("Play-Fehler:", e.name, e.message);
            alert("Play fehlgeschlagen ‚Äì tippe erneut");
        });
    } else {
        audio.pause();
        playPauseBtn.textContent = "‚ñ∂ Play";
        vizPlayPauseBtn.textContent = "‚ñ∂";
        console.log("Audio pausiert");
    }
}

function loadSong(index) {
    currentIndex = index;
    const fileName = songs[index];
    const safeName = encodeURIComponent(fileName);
    const url = BASE_URL + safeName;
    console.log("Lade Song:", url);
    audio.src = url;
    songSelect.value = index;
    if (vizSongSelect) vizSongSelect.value = index;
    downloadBtn.href = url;
    downloadBtn.setAttribute("download", fileName);
    document.getElementById("currentSong").textContent = "‚ñ∂ " + songSelect.options[index].text;
}

function selectSong() {
    resumeAudioContext();
    loadSong(parseInt(songSelect.value));
    togglePlay();
}

function selectSongFromViz() {
    resumeAudioContext();
    loadSong(parseInt(vizSongSelect.value));
    togglePlay();
}

function nextSong() {
    if (radioMode) {
        loadSong(Math.floor(Math.random() * songs.length));
    } else {
        loadSong((currentIndex + 1) % songs.length);
    }
    togglePlay();
}

function prevSong() {
    if (radioMode) return;
    loadSong((currentIndex - 1 + songs.length) % songs.length);
    togglePlay();
}

function stopSong() {
    audio.pause();
    audio.currentTime = 0;
    playPauseBtn.textContent = "‚ñ∂ Play";
    vizPlayPauseBtn.textContent = "‚ñ∂";
}

function toggleRadioMode() {
    radioMode = !radioMode;
    if (radioMode) {
        alert("Radio-Modus aktiviert!\nSongs werden nun zuf√§llig abgespielt.");
        loopCurrent = false;
        updateLoopButtonState();
        loadSong(Math.floor(Math.random() * songs.length));
        togglePlay();
        radioToggle.textContent = "üéß Radio aus";
    } else {
        alert("Radio-Modus deaktiviert.\nNormale Playlist-Wiedergabe.");
        updateLoopButtonState();
        radioToggle.textContent = "üéß Radio-Modus";
    }
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

loopBtn.addEventListener("click", () => {
    if (radioMode) return;
    loopCurrent = !loopCurrent;
    loopBtn.classList.toggle("active", loopCurrent);
});

audio.addEventListener("timeupdate", () => {
    if (!audio.duration) return;
    progress.value = (audio.currentTime / audio.duration) * 100;
    timeLabel.textContent = formatTime(audio.currentTime);
    durationLabel.textContent = formatTime(audio.duration);
});

progress.addEventListener("input", () => {
    audio.currentTime = (progress.value / 100) * audio.duration;
});

volumeSlider.addEventListener("input", () => {
    audio.volume = volumeSlider.value;
});

function formatTime(time) {
    if (isNaN(time)) return "0:00";
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60).toString().padStart(2, "0");
    return minutes + ":" + seconds;
}

audio.addEventListener("ended", () => {
    if (loopCurrent && !radioMode) {
        audio.currentTime = 0;
        togglePlay();
    } else {
        nextSong();
    }
});

function updateLoopButtonState() {
    if (radioMode) {
        loopCurrent = false;
        loopBtn.classList.remove("active");
        loopBtn.disabled = true;
    } else {
        loopBtn.disabled = false;
    }
}

// VISUALIZER FUNKTIONEN (JETZT VOLLST√ÑNDIG!)
function resizeCanvas() {
    const maxW = Math.min(window.innerWidth * 0.94, 1100);
    const maxH = window.innerHeight * 0.72;
    const ratio = 900 / 620;
    let w = maxW;
    let h = w / ratio;
    if (h > maxH) { h = maxH; w = h * ratio; }
    canvas.width = Math.floor(w);
    canvas.height = Math.floor(h);
}

function drawRing() {
    ctx.save();
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
  
    const logoBase = Math.min(canvas.width, canvas.height) * 0.32;
    const logoSize = logoBase;
  
    if (logoImg.complete) {
        ctx.shadowBlur = 30;
        ctx.shadowColor = 'rgba(0,255,255,0.5)';
        ctx.drawImage(logoImg, centerX - logoSize/2, centerY - logoSize/2, logoSize, logoSize);
    }
  
    const ringRadius = logoSize * 0.6;
    const ringThickness = 6;
    const ringOpacity = 0.4;
  
    ctx.beginPath();
    ctx.arc(centerX, centerY, ringRadius, 0, Math.PI * 2);
    ctx.lineWidth = ringThickness;
    ctx.strokeStyle = `hsla(200, 100%, 70%, ${ringOpacity})`;
    ctx.shadowBlur = 25;
    ctx.shadowColor = `rgba(0, 255, 255, 0.6)`;
    ctx.stroke();
  
    const rayCount = 72;
    for (let i = 0; i < rayCount; i++) {
        const angle = (i / rayCount) * Math.PI * 2;
        const mirroredIndex = Math.min(i, rayCount - 1 - i);
        const freqIndex = Math.floor((mirroredIndex / rayCount) * bufferLength);
        const amp = fadeDataArray[freqIndex] / 255;
      
        const rayLength = amp * (ringRadius * 0.5);
      
        const innerX = centerX + Math.cos(angle) * ringRadius;
        const innerY = centerY + Math.sin(angle) * ringRadius;
        const outerX = centerX + Math.cos(angle) * (ringRadius + rayLength);
        const outerY = centerY + Math.sin(angle) * (ringRadius + rayLength);
      
        const hue = 180 + (i * 5) % 180;
        ctx.strokeStyle = `hsla(${hue}, 100%, ${60 + amp * 40}%, ${0.7 + amp * 0.3})`;
        ctx.lineWidth = 2 + amp * 8;
        ctx.shadowBlur = 15 + amp * 30;
        ctx.shadowColor = `hsla(${hue}, 100%, 80%, 0.7)`;
      
        ctx.beginPath();
        ctx.moveTo(innerX, innerY);
        ctx.lineTo(outerX, outerY);
        ctx.stroke();
    }
  
    ctx.restore();
}

function drawWaveform() {
    const baseY = canvas.height - 40;
    ctx.beginPath();
    ctx.moveTo(0, baseY);
  
    const sliceWidth = canvas.width * 1.0 / bufferLength;
    let x = 0;
  
    for (let i = 0; i < bufferLength; i++) {
        const mirroredIndex = Math.min(i, bufferLength - 1 - i);
        let v = fadeDataArray[mirroredIndex] / 128.0;
      
        if (mirroredIndex > bufferLength * 0.6) {
            v *= 1.35 + Math.random() * 0.15;
            v = Math.min(v, 2.0);
        }
      
        const y = baseY - (v * canvas.height * 0.45);
      
        ctx.lineTo(x, y);
        x += sliceWidth;
    }
  
    ctx.lineTo(canvas.width, baseY);
    ctx.lineTo(0, baseY);
    ctx.closePath();
  
    const gradient = ctx.createLinearGradient(0, baseY, 0, baseY - canvas.height * 0.45);
    gradient.addColorStop(0, 'rgba(0, 255, 255, 0.7)');
    gradient.addColorStop(0.5, 'rgba(145, 70, 255, 0.5)');
    gradient.addColorStop(1, 'rgba(0, 255, 255, 0.2)');
  
    ctx.fillStyle = gradient;
    ctx.fill();
  
    ctx.strokeStyle = '#00ffff';
    ctx.lineWidth = 4 + Math.max(...fadeDataArray) / 255 * 6;
    ctx.shadowBlur = 25;
    ctx.shadowColor = '#00ffff';
    ctx.stroke();
}

function drawBars() {
    const barWidth = (canvas.width / bufferLength) * 1.65;
    let x = 15;
    for (let i = 0; i < bufferLength; i++) {
        const height = (fadeDataArray[i] / 255) * (canvas.height * 0.82);
        ctx.fillStyle = `hsl(${190 + (i * 1.4)}, 100%, 65%)`;
        ctx.fillRect(x, canvas.height - height - 55, barWidth, height);
        x += barWidth + 4;
    }
}

function drawLightning() {
    if (audio.paused || audio.ended || !audio.duration || audio.currentTime === 0) return;
    const bass = Math.max(...fadeDataArray.slice(0,40)) / 255;
    ctx.fillStyle = `rgba(0,255,255,${bass * 0.08})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    const numBolts = 2 + Math.floor(bass * 8);
    for (let i = 0; i < numBolts; i++) {
        let x = 30 + Math.random() * (canvas.width - 60);
        let y = 0;
        ctx.strokeStyle = `hsl(195, 100%, ${60 + bass * 25}%)`;
        ctx.lineWidth = 1.8 + bass * 7;
        ctx.shadowBlur = 30 + bass * 35;
        ctx.shadowColor = 'rgba(160,255,255,0.6)';
        ctx.beginPath();
        ctx.moveTo(x, y);
        const steps = 8 + Math.floor(bass * 5);
        for (let s = 1; s < steps; s++) {
            y += canvas.height / steps * (0.7 + Math.random() * 0.4);
            x += (Math.random() - 0.5) * (60 + bass * 140);
            ctx.lineTo(x, y);
        }
        ctx.stroke();
    }
}

function drawVisualizer() {
    animationId = requestAnimationFrame(drawVisualizer);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  
    if (audio.paused || audio.ended || audio.currentTime === 0) {
        for (let i = 0; i < bufferLength; i++) {
            fadeDataArray[i] *= 0.95;
            if (fadeDataArray[i] < 1) fadeDataArray[i] = 0;
        }
    } else {
        analyser.getByteFrequencyData(fadeDataArray);
    }
  
    if (vizMode === 0) drawRing();
    else if (vizMode === 1) drawWaveform();
    else if (vizMode === 2) drawBars();
    else drawLightning();
}

function startVisualizer() {
    if (!audioContext) initAudioContext();
    resumeAudioContext();
    resizeCanvas();
    if (!animationId) {
        console.log("Visualizer-Animation gestartet");
        drawVisualizer();
    }
}

function stopVisualizer() {
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
        console.log("Visualizer gestoppt");
    }
}

function populateVizSongSelect() {
    vizSongSelect.innerHTML = songSelect.innerHTML;
    vizSongSelect.value = currentIndex;
}

// EVENT LISTENER F√úR VISUALIZER
visualizerBtn.addEventListener('click', () => {
    console.log("Visualizer-Button geklickt ‚Äì starte Overlay");
    resumeAudioContext();
    if (audio.paused) {
        console.log("Audio war pausiert ‚Äì starte Play f√ºr Analyser");
        togglePlay();
    }
    visualizerOverlay.classList.add('active');
    populateVizSongSelect();
    startVisualizer();
});

closeVisualizer.addEventListener('click', () => {
    visualizerOverlay.classList.remove('active');
    stopVisualizer();
});

modeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        modeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        vizMode = parseInt(btn.dataset.mode);
        console.log("Visualizer-Modus gewechselt zu:", vizMode);
    });
});

document.addEventListener('keydown', e => {
    if (e.key === "Escape" && visualizerOverlay.classList.contains('active')) {
        closeVisualizer.click();
    }
});

window.addEventListener('resize', () => {
    if (visualizerOverlay.classList.contains('active')) resizeCanvas();
});

// START
window.addEventListener('load', () => {
    const saved = localStorage.getItem('playerTheme');
    if (saved === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
    }
    loadSong(0);
    updateLoopButtonState();
    populateVizSongSelect();
    resizeCanvas();
    volumeSlider.value = 0.5;
    console.log("Seite vollst√§ndig geladen ‚Äì Visualizer sollte jetzt funktionieren");
});
</script>
</body>
</html>
